const append = Element.prototype.append;

function el(name, props, ...children) {
 let elem = document.createElement(name);
 
 if (props) {
  for (let key in props) {
   if(key == 'data') {
    for (let d in props[key]) elem.dataset[d] = props[key][d];
   } else {
    elem[key] = props[key];
   }
  }
 }
 
 children.length && append.apply(elem, children);
 
 return elem;
}

function getPips(open, close) {
 if (!open || !close) return 0;
 
 // Remove the last number then the ('.'), by extracting only numbers
 open = open.slice(0, -1).match(/\d/g).join('');
 
 close = close.slice(0, -1).match(/\d/g).join('');
 
 return Number(String(Number(open) - Number(close)).match(/\d/g).join(''));
}

function td(data, isInput) {
 if(isInput) {
  return el('td', null, el('input', { value: data.text, type: data.type || 'number', data: data.data }));
 }
 
 return el('td', null, el('span', null, data));
}

let oldBalance = 1200;
let pairs = localStorage.getItem('fxpairs'), proto = () => ({
 n: 'xauusd',
 l: '0.01',
 o: '2908.23',
 c: '2910.20'
});

pairs = pairs && JSON.parse(pairs) || [proto()];

function updateStorage(e, ind, key) {
 pairs[ind][key] = e.target.value;
 localStorage.setItem('fxpairs', JSON.stringify(pairs));
}

function updateData(e) {
 let p = e.parentElement.parentElement;
 let [, lot, open, close] = p.getElementsByTagName('input');
 let [pips, pnl, pct] = p.getElementsByTagName('span');
 let pip = getPips(open.value, close.value), pNl = (lot.value * 10 * pip);
 
 pips.textContent = pip.toFixed(1);
 pnl.textContent = pNl;
 
 pct.textContent = ((100 / oldBalance) * pNl).toFixed(1) + "%";
}

table.addEventListener('mouseout', function(e) {
 if(e.target.tagName.toLowerCase() != 'input') return;
 
 let targ = e.target;
 let { type, ind, update } = targ.dataset;
 updateStorage(e, ind, type);
 update && updateData(targ);
});

function createPair(pair, ind) {
 let pip = getPips(pair.o, pair.c);
 
 table.append(
  el('tr', null,
   td({ text: pair.n.toUpperCase(), data: { type: 'n', ind }, type: 'text' }, 1),
   td({ text: pair.l, data: { type: 'l', ind, update: 1 } }, 1),
   td({ text: pair.o, data: { type: 'o', ind, update: 1 } }, 1),
   td({ text: pair.c, data: { type: 'c', ind, update: 1 } }, 1),
   td(pip), 
   td((pair.l * 10 * pip).toFixed(1)), 
   td(((100 / oldBalance) * ((pair.l * 10 * pip).toFixed())).toFixed(1) + "%")
  )
 );
}

pairs.forEach(createPair);

addPair.addEventListener('click', function() {
 if(!confirm('Add new pair?')) return;
 
 pairs.push(proto());
 localStorage.setItem('fxpairs', JSON.stringify(pairs));
 createPair(pairs[pairs.length -1], pairs.length -1);
});

balance.onblur = function() {
 if(this.value == oldBalance) return;
 
 oldBalance = this.value;
 table.innerHTML = '';
 pairs.forEach(createPair);
}



let data = (`2025 - 04 - 07 00: 00: 00, 3005.02002, 3009.76001, 2971.1499, 2981.63989
2025 - 04 - 07 00: 15: 00, 2981.62988, 2991.21997, 2975.8999, 2985.31006
2025 - 04 - 07 00: 30: 00, 2985.33008, 2992.77002, 2979.8501, 2983.07007
2025 - 04 - 07 00: 45: 00, 2982.96997, 2988.82007, 2973.34009, 2979.06006
2025 - 04 - 07 01: 00: 00, 2979.06006, 3008.96997, 2972.25, 3006.78003
2025 - 04 - 07 01: 15: 00, 3006.71997, 3020.65991, 3005.0, 3019.1499
2025 - 04 - 07 01: 30: 00, 3019.13989, 3055.33008, 3016.41992, 3052.17993
2025 - 04 - 07 01: 45: 00, 3052.18994, 3055.25, 3036.62988, 3038.46997
2025 - 04 - 07 02: 00: 00, 3038.48999, 3055.62012, 3036.22998, 3053.02002
2025 - 04 - 07 02: 15: 00, 3052.98999, 3053.6499, 3040.12988, 3042.52002
2025 - 04 - 07 02: 30: 00, 3042.62012, 3045.08008, 3027.53003, 3032.55005
2025 - 04 - 07 02: 45: 00, 3032.81006, 3036.07007, 3024.5, 3026.22998
2025 - 04 - 07 03: 00: 00, 3025.97998, 3030.30005, 3021.97998, 3026.21997
2025 - 04 - 07 03: 15: 00, 3026.19995, 3031.52002, 3025.66992, 3030.09009
2025 - 04 - 07 03: 30: 00, 3030.07007, 3034.13989, 3026.27002, 3027.40991
2025 - 04 - 07 03: 45: 00, 3027.3999, 3029.21997, 3017.26001, 3019.05005
2025 - 04 - 07 04: 00: 00, 3019.06006, 3031.94995, 3019.03003, 3027.26001
2025 - 04 - 07 04: 15: 00, 3027.23999, 3030.27002, 3023.90991, 3026.58008
2025 - 04 - 07 04: 30: 00, 3026.59009, 3032.93994, 3025.30005, 3028.04004
2025 - 04 - 07 04: 45: 00, 3028.03003, 3035.68994, 3026.1499, 3035.54004
2025 - 04 - 07 05: 00: 00, 3035.55005, 3037.65991, 3025.05005, 3029.63989
2025 - 04 - 07 05: 15: 00, 3029.63989, 3040.20996, 3029.38989, 3038.8501
2025 - 04 - 07 05: 30: 00, 3038.8501, 3044.61011, 3033.96997, 3039.32007
2025 - 04 - 07 05: 45: 00, 3039.31006, 3043.51001, 3031.94995, 3032.04004
2025 - 04 - 07 06: 00: 00, 3032.03003, 3033.48999, 3022.38989, 3027.02002
2025 - 04 - 07 06: 15: 00, 3026.98999, 3028.08008, 3016.72998, 3018.57007
2025 - 04 - 07 06: 30: 00, 3018.57007, 3031.3501, 3018.57007, 3027.88989
2025 - 04 - 07 06: 45: 00, 3027.8999, 3030.78003, 3018.83008, 3029.40991
2025 - 04 - 07 07: 00: 00, 3028.57007, 3030.81006, 3013.3999, 3014.43994
2025 - 04 - 07 07: 15: 00, 3014.30005, 3027.37988, 3013.8501, 3019.19995
2025 - 04 - 07 07: 30: 00, 3019.15991, 3026.62012, 3019.15991, 3019.37988
2025 - 04 - 07 07: 45: 00, 3019.38989, 3029.26001, 3015.93994, 3018.67993
2025 - 04 - 07 08: 00: 00, 3018.66992, 3028.34009, 3018.12012, 3027.87988
2025 - 04 - 07 08: 15: 00, 3027.87012, 3029.73999, 3023.26001, 3023.61011
2025 - 04 - 07 08: 30: 00, 3023.63989, 3028.80005, 3021.13989, 3027.52002
2025 - 04 - 07 08: 45: 00, 3027.52002, 3035.43994, 3026.93994, 3031.23999
2025 - 04 - 07 09: 00: 00, 3031.51001, 3033.51001, 3025.73999, 3027.83008
2025 - 04 - 07 09: 15: 00, 3027.82007, 3027.8501, 3019.6499, 3026.65991
2025 - 04 - 07 09: 30: 00, 3026.67993, 3031.71997, 3024.19995, 3025.84009
2025 - 04 - 07 09: 45: 00, 3025.8501, 3028.86011, 3019.73999, 3025.26001
2025 - 04 - 07 10: 00: 00, 3025.25, 3030.86011, 3024.26001, 3026.83008
2025 - 04 - 07 10: 15: 00, 3026.86011, 3033.32007, 3026.42993, 3032.70996
2025 - 04 - 07 10: 30: 00, 3032.71997, 3036.3999, 3031.88989, 3032.46997
2025 - 04 - 07 10: 45: 00, 3032.42993, 3036.56006, 3030.17993, 3031.3999
2025 - 04 - 07 11: 00: 00, 3031.3999, 3042.46997, 3031.12012, 3040.56006
2025 - 04 - 07 11: 15: 00, 3040.44995, 3044.29004, 3038.84009, 3040.19995
2025 - 04 - 07 11: 30: 00, 3040.20996, 3046.08008, 3038.8999, 3039.55005
2025 - 04 - 07 11: 45: 00, 3039.51001, 3040.3999, 3030.27002, 3031.26001
2025 - 04 - 07 12: 00: 00, 3031.34009, 3031.69995, 3025.20996, 3025.87012
2025 - 04 - 07 12: 15: 00, 3025.8501, 3031.59009, 3024.80005, 3026.72998
2025 - 04 - 07 12: 30: 00, 3026.71997, 3030.27002, 3014.94995, 3020.32007
2025 - 04 - 07 12: 45: 00, 3020.34009, 3032.8999, 3019.6499, 3031.27002
2025 - 04 - 07 13: 00: 00, 3031.26001, 3034.11011, 3024.57007, 3027.6499
2025 - 04 - 07 13: 15: 00, 3027.65991, 3030.27002, 3021.54004, 3024.70996
2025 - 04 - 07 13: 30: 00, 3024.55005, 3026.67993, 3002.32007, 3007.1001
2025 - 04 - 07 13: 45: 00, 3007.01001, 3019.26001, 3004.13989, 3015.66992
2025 - 04 - 07 14: 00: 00, 3015.44995, 3031.65991, 3011.03003, 3027.57007
2025 - 04 - 07 14: 15: 00, 3027.38989, 3038.11011, 3005.79004, 3009.01001
2025 - 04 - 07 14: 30: 00, 3008.55005, 3013.95996, 2997.40991, 3003.12012
2025 - 04 - 07 14: 45: 00, 3003.12012, 3007.93994, 2996.6499, 2999.23999
2025 - 04 - 07 15: 00: 00, 2998.56006, 3004.71997, 2984.47998, 2984.86011
2025 - 04 - 07 15: 15: 00, 2984.80005, 2998.72998, 2984.52002, 2986.98999
2025 - 04 - 07 15: 30: 00, 2987.11011, 2988.69995, 2981.23999, 2984.6001
2025 - 04 - 07 15: 45: 00, 2984.61011, 2988.1499, 2979.97998, 2987.61011
2025 - 04 - 07 16: 00: 00, 2987.6001, 2987.87012, 2977.18994, 2979.98999
2025 - 04 - 07 16: 15: 00, 2980.01001, 2985.43994, 2975.26001, 2978.05005
2025 - 04 - 07 16: 30: 00, 2978.03003, 2984.82007, 2975.18994, 2975.38989
2025 - 04 - 07 16: 45: 00, 2975.3999, 2975.70996, 2970.06006, 2970.6499
2025 - 04 - 07 17: 00: 00, 2970.67993, 2975.22998, 2959.69995, 2966.07007
2025 - 04 - 07 17: 15: 00, 2966.28003, 2970.73999, 2957.06006, 2959.09009
2025 - 04 - 07 17: 30: 00, 2959.1001, 2968.97998, 2956.65991, 2968.31006
2025 - 04 - 07 17: 45: 00, 2968.31006, 2973.78003, 2966.17993, 2970.1499
2025 - 04 - 07 18: 00: 00, 2970.12988, 2973.46997, 2969.44995, 2971.03003
2025 - 04 - 07 18: 15: 00, 2971.06006, 2974.15991, 2969.28003, 2969.78003
2025 - 04 - 07 18: 30: 00, 2969.87012, 2976.79004, 2968.70996, 2971.86011
2025 - 04 - 07 18: 45: 00, 2971.8501, 2972.51001, 2964.0, 2965.81006
2025 - 04 - 07 19: 00: 00, 2965.82007, 2972.88989, 2965.36011, 2971.86011
2025 - 04 - 07 19: 15: 00, 2971.87988, 2975.55005, 2969.51001, 2974.17993
2025 - 04 - 07 19: 30: 00, 2974.15991, 2982.1499, 2973.55005, 2978.44995
2025 - 04 - 07 19: 45: 00, 2978.55005, 2978.88989, 2974.87988, 2976.63989
2025 - 04 - 07 20: 00: 00, 2976.6499, 2980.72998, 2970.28003, 2979.51001
2025 - 04 - 07 20: 15: 00, 2979.51001, 2986.0, 2979.51001, 2984.03003
2025 - 04 - 07 20: 30: 00, 2984.01001, 2986.19995, 2983.46997, 2985.27002
2025 - 04 - 07 20: 45: 00, 2985.28003, 2985.31006, 2981.92993, 2983.42993
2025 - 04 - 07 21: 00: 00, 2983.44995, 2983.44995, 2980.98999, 2981.02002
2025 - 04 - 07 21: 15: 00, 2984.38989, 2984.3999, 2984.13989, 2984.1499
2025 - 04 - 07 21: 30: 00, 2984.13989, 2984.3999, 2983.32007, 2984.16992
2025 - 04 - 07 21: 45: 00, 2984.15991, 2992.76001, 2975.65991, 2977.77002
2025 - 04 - 07 22: 00: 00, 2977.78003, 2986.94995, 2977.78003, 2984.09009
2025 - 04 - 07 22: 15: 00, 2984.1001, 2985.84009, 2982.52002, 2985.77002
2025 - 04 - 07 22: 30: 00, 2985.78003, 2988.43994, 2983.72998, 2983.8501
2025 - 04 - 07 22: 45: 00, 2983.8501, 2988.63989, 2983.57007, 2986.81006
2025 - 04 - 07 23: 00: 00, 2986.84009, 2987.43994, 2985.09009, 2985.88989
2025 - 04 - 07 23: 15: 00, 2985.88989, 2985.90991, 2981.65991, 2981.84009
2025 - 04 - 07 23: 30: 00, 2981.83008, 2983.33008, 2978.57007, 2980.12988
2025 - 04 - 07 23: 45: 00, 2980.1499, 2983.33008, 2980.13989, 2981.01001
2025 - 04 - 08 00: 00: 00, 2982.8999, 2987.43994, 2980.38989, 2985.42993
2025 - 04 - 08 00: 15: 00, 2985.40991, 2989.0, 2983.8501, 2988.93994
2025 - 04 - 08 00: 30: 00, 2988.92993, 2992.65991, 2988.52002, 2991.67993
2025 - 04 - 08 00: 45: 00, 2991.68994, 2991.84009, 2983.01001, 2985.40991
2025 - 04 - 08 01: 00: 00, 2985.43994, 3000.97998, 2983.69995, 2995.42993
2025 - 04 - 08 01: 15: 00, 2995.42993, 2999.8999, 2989.68994, 2996.20996
2025 - 04 - 08 01: 30: 00, 2996.19995, 3003.22998, 2995.02002, 3000.21997
2025 - 04 - 08 01: 45: 00, 3000.19995, 3001.23999, 2996.36011, 2999.8501
2025 - 04 - 08 02: 00: 00, 2999.86011, 3004.82007, 2999.27002, 3002.56006
2025 - 04 - 08 02: 15: 00, 3002.54004, 3003.40991, 2998.36011, 2999.78003
2025 - 04 - 08 02: 30: 00, 2999.76001, 3004.82007, 2998.65991, 3003.6001
2025 - 04 - 08 02: 45: 00, 3003.61011, 3004.26001, 2999.53003, 3001.04004
2025 - 04 - 08 03: 00: 00, 3001.04004, 3001.13989, 2993.17993, 2995.3999
2025 - 04 - 08 03: 15: 00, 2995.40991, 3000.87012, 2994.17993, 2995.36011
2025 - 04 - 08 03: 30: 00, 2995.3501, 2998.52002, 2994.86011, 2998.31006
2025 - 04 - 08 03: 45: 00, 2998.28003, 2999.03003, 2993.78003, 2994.87988
2025 - 04 - 08 04: 00: 00, 2994.86011, 2999.80005, 2994.29004, 2998.70996
2025 - 04 - 08 04: 15: 00, 2998.76001, 2999.01001, 2995.42993, 2996.11011
2025 - 04 - 08 04: 30: 00, 2996.11011, 2997.37988, 2991.02002, 2995.53003
2025 - 04 - 08 04: 45: 00, 2995.48999, 3002.97998, 2994.76001, 3002.26001
2025 - 04 - 08 05: 00: 00, 3002.27002, 3004.36011, 3000.02002, 3004.19995
2025 - 04 - 08 05: 15: 00, 3004.19995, 3005.34009, 2999.96997, 3000.13989
2025 - 04 - 08 05: 30: 00, 3000.13989, 3005.30005, 2999.59009, 3000.56006
2025 - 04 - 08 05: 45: 00, 3000.57007, 3008.31006, 3000.44995, 3005.78003
2025 - 04 - 08 06: 00: 00, 3005.71997, 3006.46997, 3002.6001, 3004.59009
2025 - 04 - 08 06: 15: 00, 3004.6001, 3013.53003, 3004.25, 3011.8501
2025 - 04 - 08 06: 30: 00, 3011.86011, 3015.78003, 3010.62988, 3013.73999
2025 - 04 - 08 06: 45: 00, 3013.73999, 3014.11011, 3011.11011, 3013.36011
2025 - 04 - 08 07: 00: 00, 3013.38989, 3013.52002, 3008.32007, 3012.16992
2025 - 04 - 08 07: 15: 00, 3012.15991, 3013.88989, 3007.70996, 3010.07007
2025 - 04 - 08 07: 30: 00, 3010.07007, 3011.46997, 3002.40991, 3003.19995
2025 - 04 - 08 07: 45: 00, 3003.18994, 3006.73999, 3001.94995, 3003.70996
2025 - 04 - 08 08: 00: 00, 3003.63989, 3008.15991, 3001.43994, 3007.30005
2025 - 04 - 08 08: 15: 00, 3007.31006, 3009.42993, 3006.30005, 3008.92993
2025 - 04 - 08 08: 30: 00, 3008.92993, 3009.12012, 3003.76001, 3007.55005
2025 - 04 - 08 08: 45: 00, 3007.53003, 3008.13989, 3004.36011, 3007.53003
2025 - 04 - 08 09: 00: 00, 3007.5, 3007.5, 3002.51001, 3003.20996
2025 - 04 - 08 09: 15: 00, 3003.21997, 3003.22998, 2995.01001, 2995.92993
2025 - 04 - 08 09: 30: 00, 2995.93994, 3007.82007, 2995.93994, 3006.48999
2025 - 04 - 08 09: 45: 00, 3006.3999, 3007.84009, 3003.27002, 3006.87012
2025 - 04 - 08 10: 00: 00, 3006.90991, 3008.73999, 3004.13989, 3005.40991
2025 - 04 - 08 10: 15: 00, 3005.3999, 3008.91992, 3004.65991, 3008.12012
2025 - 04 - 08 10: 30: 00, 3008.12012, 3009.87988, 3005.54004, 3008.19995
2025 - 04 - 08 10: 45: 00, 3008.18994, 3010.28003, 3007.22998, 3008.98999
2025 - 04 - 08 11: 00: 00, 3008.97998, 3011.93994, 3008.68994, 3011.38989
2025 - 04 - 08 11: 15: 00, 3011.37988, 3014.28003, 3010.46997, 3010.6499
2025 - 04 - 08 11: 30: 00, 3010.65991, 3013.42993, 3008.92993, 3009.40991
2025 - 04 - 08 11: 45: 00, 3009.52002, 3019.47998, 3009.21997, 3017.58008
2025 - 04 - 08 12: 00: 00, 3017.57007, 3019.42993, 3014.1499, 3017.80005
2025 - 04 - 08 12: 15: 00, 3017.78003, 3017.78003, 3003.43994, 3009.81006
2025 - 04 - 08 12: 30: 00, 3009.81006, 3012.98999, 3006.8999, 3007.09009
2025 - 04 - 08 12: 45: 00, 3007.09009, 3008.57007, 3002.5, 3002.67993
2025 - 04 - 08 13: 00: 00, 3002.65991, 3020.3501, 3002.62012, 3018.57007
2025 - 04 - 08 13: 15: 00, 3018.59009, 3022.73999, 3013.30005, 3013.72998
2025 - 04 - 08 13: 30: 00, 3013.68994, 3017.23999, 3006.41992, 3006.81006
2025 - 04 - 08 13: 45: 00, 3006.82007, 3011.92993, 3004.05005, 3010.48999
2025 - 04 - 08 14: 00: 00, 3010.47998, 3017.97998, 3009.30005, 3011.5
2025 - 04 - 08 14: 15: 00, 3011.51001, 3014.93994, 3008.51001, 3012.55005
2025 - 04 - 08 14: 30: 00, 3012.58008, 3017.63989, 3010.28003, 3014.1499
2025 - 04 - 08 14: 45: 00, 3014.12988, 3018.30005, 3005.94995, 3006.28003
2025 - 04 - 08 15: 00: 00, 3006.29004, 3008.15991, 3002.63989, 3004.65991
2025 - 04 - 08 15: 15: 00, 3004.6499, 3010.01001, 3004.57007, 3007.72998
2025 - 04 - 08 15: 30: 00, 3007.72998, 3012.38989, 3004.80005, 3005.17993
2025 - 04 - 08 15: 45: 00, 3005.17993, 3006.37012, 3001.31006, 3001.57007
2025 - 04 - 08 16: 00: 00, 3001.57007, 3001.57007, 2994.51001, 2999.34009
2025 - 04 - 08 16: 15: 00, 2999.37988, 2999.61011, 2992.51001, 2994.80005
2025 - 04 - 08 16: 30: 00, 2994.79004, 2996.09009, 2985.33008, 2985.56006
2025 - 04 - 08 16: 45: 00, 2985.55005, 2990.30005, 2984.46997, 2985.96997
2025 - 04 - 08 17: 00: 00, 2985.98999, 2986.38989, 2976.61011, 2981.15991
2025 - 04 - 08 17: 15: 00, 2981.13989, 2984.28003, 2975.3999, 2976.61011
2025 - 04 - 08 17: 30: 00, 2976.59009, 2983.86011, 2974.82007, 2983.36011
2025 - 04 - 08 17: 45: 00, 2983.36011, 2987.45996, 2981.8999, 2985.1499
2025 - 04 - 08 18: 00: 00, 2985.17993, 2985.18994, 2984.15991, 2984.75`);

data = data.split(/\n/);
data =  data.map(d => d.match(/\b(\d+[.]\d+)?/g).filter(e => e)).map((a, b) => ({
  open: a[0],
  high: a[1],
  low: a[2],
  close: a[3]
 }));
 /*
 canvas.width = 400;
 canvas.height = 300;
 let ctx = canvas.getContext('2d');
 console.log(ctx)*/
 document.write(JSON.stringify(data));
// Here's an example of how to calculate the slope of a linear regression line using plain math:

// Array of numbers
let numbers = [10, 20, 40, 80, 160, 320, 500, 1280];

// Calculate mean of x and y
let n = numbers.length;
let x_mean = (n * (n + 1)) / 2.0; // Mean of x values (1 to n)
let y_mean = numbers.reduce((a, b) => a + b, 0) / n; // Mean of y values

// Calculate slope and intercept
let numerator = 0;
let denominator = 0;
for (let i = 1; i <= n; i++) {
  numerator += (i - x_mean) * (numbers[i-1] - y_mean);
  denominator += Math.pow(i - x_mean, 2);
}
let slope = numerator / denominator;

// Check if slope is positive
console.log(slope);// > 0 ? "Upward trend" : "No upward trend");
